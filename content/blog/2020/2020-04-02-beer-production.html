---
title: "Bootstrap resampling with #TidyTuesday beer production data"
date: 2020-04-02
slug: "beer-production"
tags: [rstats,tidymodels]
---



<p>I‚Äôve been publishing <a href="https://juliasilge.com/tags/tidymodels/">screencasts</a> demonstrating how to use the tidymodels framework, from first steps in modeling to how to tune more complex models. Today, I‚Äôm using this week‚Äôs <a href="https://github.com/rfordatascience/tidytuesday"><code>#TidyTuesday</code> dataset</a> on beer production to show how to use bootstrap resampling to estimate model parameters.</p>
{{% youtube "7LGR1sEUXoI" %}}
<p></br></p>
<p>Here is the code I used in the video, for those who prefer reading instead of or in addition to video.</p>
<div id="explore-the-data" class="section level2">
<h2>Explore the data</h2>
<p>Our modeling goal here is to estimate how much <strong>sugar</strong> beer producers use relative to <strong>malt</strong> according to the <a href="https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-03-31/readme.md">#TidyTuesday dataset</a>. We‚Äôll use bootstrap resampling to do this! üçª</p>
<p>First, let‚Äôs look at the data on brewing materials.</p>
<pre class="r"><code>library(tidyverse)

brewing_materials_raw &lt;- read_csv(&quot;https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-03-31/brewing_materials.csv&quot;)

brewing_materials_raw %&gt;%
  count(type, wt = month_current, sort = TRUE)</code></pre>
<pre><code>## # A tibble: 12 x 2
##    type                                 n
##    &lt;chr&gt;                            &lt;dbl&gt;
##  1 Total Used                 53559516695
##  2 Total Grain products       44734903124
##  3 Malt and malt products     32697313882
##  4 Total Non-Grain products    8824613571
##  5 Sugar and syrups            6653104081
##  6 Rice and rice products      5685742541
##  7 Corn and corn products      5207759409
##  8 Hops (dry)                  1138840132
##  9 Other                        998968470
## 10 Barley and barley products   941444745
## 11 Wheat and wheat products     202642547
## 12 Hops (used as extracts)       33700888</code></pre>
<p>How have some different brewing materials changed over time?</p>
<pre class="r"><code>brewing_filtered &lt;- brewing_materials_raw %&gt;%
  filter(
    type %in% c(
      &quot;Malt and malt products&quot;,
      &quot;Sugar and syrups&quot;,
      &quot;Hops (dry)&quot;
    ),
    year &lt; 2016,
    !(month == 12 &amp; year %in% 2014:2015)
  ) %&gt;%
  mutate(
    date = paste0(year, &quot;-&quot;, month, &quot;-01&quot;),
    date = lubridate::ymd(date)
  )

brewing_filtered %&gt;%
  ggplot(aes(date, month_current, color = type)) +
  geom_point()</code></pre>
<p><img src="/blog/2020/2020-04-02-beer-production_files/figure-html/unnamed-chunk-3-1.png" width="2400" /></p>
<p>There are strong annual patterns in these materials. We want to measure how much sugar beer producers use relative to malt.</p>
<pre class="r"><code>brewing_materials &lt;- brewing_filtered %&gt;%
  select(date, type, month_current) %&gt;%
  pivot_wider(
    names_from = type,
    values_from = month_current
  ) %&gt;%
  janitor::clean_names()

brewing_materials</code></pre>
<pre><code>## # A tibble: 94 x 4
##    date       malt_and_malt_products sugar_and_syrups hops_dry
##    &lt;date&gt;                      &lt;dbl&gt;            &lt;dbl&gt;    &lt;dbl&gt;
##  1 2008-01-01              374165152         78358212  4506546
##  2 2008-02-01              355687578         80188744  1815271
##  3 2008-03-01              399855819         78907213  6067167
##  4 2008-04-01              388639443         81199989  6864440
##  5 2008-05-01              411307544         89946309  7470130
##  6 2008-06-01              415161326         81012422  7361941
##  7 2008-07-01              405393784         76728131  1759452
##  8 2008-08-01              389391266         83928121  5992025
##  9 2008-09-01              362587470         71982604  3788942
## 10 2008-10-01              353803777         42828943  3788949
## # ‚Ä¶ with 84 more rows</code></pre>
<pre class="r"><code>brewing_materials %&gt;%
  ggplot(aes(malt_and_malt_products, sugar_and_syrups)) +
  geom_smooth(method = &quot;lm&quot;) +
  geom_point()</code></pre>
<p><img src="/blog/2020/2020-04-02-beer-production_files/figure-html/unnamed-chunk-4-1.png" width="2400" /></p>
<p>There is a lot of variation in this relationship, but beer reproducers use more sugar when they use more malt. What is the relationship?</p>
<pre class="r"><code>library(tidymodels)

beer_fit &lt;- lm(sugar_and_syrups ~ 0 + malt_and_malt_products,
  data = brewing_materials
)

summary(beer_fit)</code></pre>
<pre><code>## 
## Call:
## lm(formula = sugar_and_syrups ~ 0 + malt_and_malt_products, data = brewing_materials)
## 
## Residuals:
##       Min        1Q    Median        3Q       Max 
## -29985291  -6468052    174001   7364462  23462837 
## 
## Coefficients:
##                        Estimate Std. Error t value Pr(&gt;|t|)    
## malt_and_malt_products 0.205804   0.003446   59.72   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 11480000 on 93 degrees of freedom
## Multiple R-squared:  0.9746, Adjusted R-squared:  0.9743 
## F-statistic:  3567 on 1 and 93 DF,  p-value: &lt; 2.2e-16</code></pre>
<pre class="r"><code>tidy(beer_fit)</code></pre>
<pre><code>## # A tibble: 1 x 5
##   term                   estimate std.error statistic  p.value
##   &lt;chr&gt;                     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 malt_and_malt_products    0.206   0.00345      59.7 5.72e-76</code></pre>
<p>Here I am choosing to set the intercept to zero to take a simplified view of the malt-sugar relationship (i.e., beer producers don‚Äôt use any sugar if they aren‚Äôt starting with malt). We could leave that off and estimate both an intercept (baseline use of sugar all the time) and slope (increase in use of sugar per barrel of malt).</p>
<p>This model and the visualization above are based on model assumptions that may not hold with our real-world beer production data. Bootstrap resampling provides predictions and confidence intervals that are more robust.</p>
</div>
<div id="bootstrap-resampling" class="section level2">
<h2>Bootstrap resampling</h2>
<p>First, let‚Äôs create a set of bootstrap resamples.</p>
<pre class="r"><code>set.seed(123)
beer_boot &lt;- bootstraps(brewing_materials, times = 1e3, apparent = TRUE)
beer_boot</code></pre>
<pre><code>## # Bootstrap sampling with apparent sample 
## # A tibble: 1,001 x 2
##    splits          id           
##    &lt;list&gt;          &lt;chr&gt;        
##  1 &lt;split [94/39]&gt; Bootstrap0001
##  2 &lt;split [94/34]&gt; Bootstrap0002
##  3 &lt;split [94/37]&gt; Bootstrap0003
##  4 &lt;split [94/39]&gt; Bootstrap0004
##  5 &lt;split [94/29]&gt; Bootstrap0005
##  6 &lt;split [94/27]&gt; Bootstrap0006
##  7 &lt;split [94/35]&gt; Bootstrap0007
##  8 &lt;split [94/33]&gt; Bootstrap0008
##  9 &lt;split [94/29]&gt; Bootstrap0009
## 10 &lt;split [94/34]&gt; Bootstrap0010
## # ‚Ä¶ with 991 more rows</code></pre>
<p>Next, let‚Äôs train a model to each of these bootstrap resamples. We can use <code>tidy()</code> with <code>map()</code> to create a dataframe of model results.</p>
<pre class="r"><code>beer_models &lt;- beer_boot %&gt;%
  mutate(
    model = map(splits, ~ lm(sugar_and_syrups ~ 0 + malt_and_malt_products, data = .)),
    coef_info = map(model, tidy)
  )

beer_coefs &lt;- beer_models %&gt;%
  unnest(coef_info)

beer_coefs</code></pre>
<pre><code>## # A tibble: 1,001 x 8
##    splits     id        model term         estimate std.error statistic  p.value
##    &lt;list&gt;     &lt;chr&gt;     &lt;lis&gt; &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1 &lt;split [9‚Ä¶ Bootstra‚Ä¶ &lt;lm&gt;  malt_and_ma‚Ä¶    0.203   0.00326      62.3 1.31e-77
##  2 &lt;split [9‚Ä¶ Bootstra‚Ä¶ &lt;lm&gt;  malt_and_ma‚Ä¶    0.208   0.00338      61.7 3.17e-77
##  3 &lt;split [9‚Ä¶ Bootstra‚Ä¶ &lt;lm&gt;  malt_and_ma‚Ä¶    0.205   0.00336      61.1 7.30e-77
##  4 &lt;split [9‚Ä¶ Bootstra‚Ä¶ &lt;lm&gt;  malt_and_ma‚Ä¶    0.206   0.00361      57.1 3.26e-74
##  5 &lt;split [9‚Ä¶ Bootstra‚Ä¶ &lt;lm&gt;  malt_and_ma‚Ä¶    0.203   0.00349      58.3 4.77e-75
##  6 &lt;split [9‚Ä¶ Bootstra‚Ä¶ &lt;lm&gt;  malt_and_ma‚Ä¶    0.209   0.00335      62.2 1.33e-77
##  7 &lt;split [9‚Ä¶ Bootstra‚Ä¶ &lt;lm&gt;  malt_and_ma‚Ä¶    0.210   0.00330      63.7 1.73e-78
##  8 &lt;split [9‚Ä¶ Bootstra‚Ä¶ &lt;lm&gt;  malt_and_ma‚Ä¶    0.209   0.00359      58.2 5.52e-75
##  9 &lt;split [9‚Ä¶ Bootstra‚Ä¶ &lt;lm&gt;  malt_and_ma‚Ä¶    0.207   0.00342      60.5 1.74e-76
## 10 &lt;split [9‚Ä¶ Bootstra‚Ä¶ &lt;lm&gt;  malt_and_ma‚Ä¶    0.207   0.00378      54.9 1.14e-72
## # ‚Ä¶ with 991 more rows</code></pre>
</div>
<div id="evaluate-results" class="section level2">
<h2>Evaluate results</h2>
<p>What is the distribution of the relationship between sugar and malt?</p>
<pre class="r"><code>beer_coefs %&gt;%
  ggplot(aes(estimate)) +
  geom_histogram(alpha = 0.7, fill = &quot;cyan3&quot;)</code></pre>
<p><img src="/blog/2020/2020-04-02-beer-production_files/figure-html/unnamed-chunk-8-1.png" width="2400" /></p>
<p>We can see where this distribution is centered and how broad it is from this visualization, and we can estimate these quantities using <code>int_pctl()</code> from the rsample package.</p>
<pre class="r"><code>int_pctl(beer_models, coef_info)</code></pre>
<pre><code>## # A tibble: 1 x 6
##   term                   .lower .estimate .upper .alpha .method   
##   &lt;chr&gt;                   &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;     
## 1 malt_and_malt_products  0.199     0.206  0.212   0.05 percentile</code></pre>
<p>We can also visualize some of these fits to the bootstrap resamples. First, let‚Äôs use <code>augment()</code> to get the fitted values for each resampled data point.</p>
<pre class="r"><code>beer_aug &lt;- beer_models %&gt;%
  sample_n(200) %&gt;%
  mutate(augmented = map(model, augment)) %&gt;%
  unnest(augmented)

beer_aug</code></pre>
<pre><code>## # A tibble: 18,800 x 13
##    splits id    model coef_info sugar_and_syrups malt_and_malt_p‚Ä¶ .fitted
##    &lt;list&gt; &lt;chr&gt; &lt;lis&gt; &lt;list&gt;               &lt;dbl&gt;            &lt;dbl&gt;   &lt;dbl&gt;
##  1 &lt;spli‚Ä¶ Boot‚Ä¶ &lt;lm&gt;  &lt;tibble ‚Ä¶         71341108        384396702  7.78e7
##  2 &lt;spli‚Ä¶ Boot‚Ä¶ &lt;lm&gt;  &lt;tibble ‚Ä¶         76728131        405393784  8.20e7
##  3 &lt;spli‚Ä¶ Boot‚Ä¶ &lt;lm&gt;  &lt;tibble ‚Ä¶         73793509        322480722  6.53e7
##  4 &lt;spli‚Ä¶ Boot‚Ä¶ &lt;lm&gt;  &lt;tibble ‚Ä¶         85703037        340319408  6.89e7
##  5 &lt;spli‚Ä¶ Boot‚Ä¶ &lt;lm&gt;  &lt;tibble ‚Ä¶         67266337        380521275  7.70e7
##  6 &lt;spli‚Ä¶ Boot‚Ä¶ &lt;lm&gt;  &lt;tibble ‚Ä¶         81199989        388639443  7.86e7
##  7 &lt;spli‚Ä¶ Boot‚Ä¶ &lt;lm&gt;  &lt;tibble ‚Ä¶         76115769        399504457  8.08e7
##  8 &lt;spli‚Ä¶ Boot‚Ä¶ &lt;lm&gt;  &lt;tibble ‚Ä¶         66002563        321371392  6.50e7
##  9 &lt;spli‚Ä¶ Boot‚Ä¶ &lt;lm&gt;  &lt;tibble ‚Ä¶         85703037        340319408  6.89e7
## 10 &lt;spli‚Ä¶ Boot‚Ä¶ &lt;lm&gt;  &lt;tibble ‚Ä¶         74805384        351222725  7.11e7
## # ‚Ä¶ with 18,790 more rows, and 6 more variables: .se.fit &lt;dbl&gt;, .resid &lt;dbl&gt;,
## #   .hat &lt;dbl&gt;, .sigma &lt;dbl&gt;, .cooksd &lt;dbl&gt;, .std.resid &lt;dbl&gt;</code></pre>
<p>Then, let‚Äôs create a visualization.</p>
<pre class="r"><code>ggplot(beer_aug, aes(malt_and_malt_products, sugar_and_syrups)) +
  geom_line(aes(y = .fitted, group = id), alpha = .2, col = &quot;cyan3&quot;) +
  geom_point()</code></pre>
<p><img src="/blog/2020/2020-04-02-beer-production_files/figure-html/unnamed-chunk-11-1.png" width="2400" /></p>
</div>
